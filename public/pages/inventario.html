<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HerbalSys - Inventario</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/static/css/styleInventory.css">
</head>

<body class="bg-light">

  <!-- NAVBAR (solo móvil) -->
  <nav class="navbar navbar-light bg-white shadow-sm d-lg-none">
    <div class="container-fluid">
      <button class="btn btn-outline-success" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebar"
        aria-controls="sidebar">
        ☰
      </button>
      <span class="navbar-brand mb-0 h1">Inventario</span>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">
      <!-- SIDEBAR -->
      <aside id="sidebar" class="col-lg-2 d-none d-lg-block bg-white vh-100 border-end pt-4">
        <div class="px-3">
          <div class="d-flex align-items-center mb-4">
            <div class="me-2">
              <svg width="34" height="34" viewBox="0 0 24 24" fill="none" class="text-success">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.2"></circle>
              </svg>
            </div>
            <div>
              <h6 class="mb-0">HerbalSys</h6>
              <small class="text-muted">Tienda Naturista P.O.S</small>
            </div>
          </div>
          <ul class="nav nav-pills flex-column">
            <li class="nav-item mb-1"><a href="../menu/" class="nav-link">Dashboard</a></li>
            <li class="nav-item mb-1"><a href="inventario.html" class="nav-link active">Inventario</a></li>
            <li class="nav-item mb-1"><a href="reportes.html" class="nav-link">Reportes</a></li>
          </ul>
        </div>
      </aside>

      <!-- MAIN -->
      <main class="col-lg-10 ms-auto px-4">
        <div class="row g-3 py-4">
          <div class="col-12 d-flex justify-content-between align-items-center">
            <h3 class="fw-bold text-success">Gestión de Inventario</h3>
            <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#modalNuevo">+ Añadir
              Producto</button>
          </div>

          <!-- Filtros -->
          <section class="col-12">
            <div class="card shadow-sm mb-3">
              <div class="card-body">
                <div class="row g-2">
                  <div class="col-md-4">
                    <input type="text" id="busquedaNombre" class="form-control" placeholder="Buscar por nombre">
                  </div>
                  <div class="col-md-3">
                    <select id="filtroCategoria" class="form-select">
                      <option value="">Categorías</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <select id="filtroProveedor" class="form-select">
                      <option value="">Proveedores</option>
                    </select>
                  </div>
                  <div class="col-md-2">
                    <button class="btn btn-success w-100">Buscar</button>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Tabla de Inventario -->
          <section class="col-12">
            <div class="card shadow-sm">
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-hover mb-0" id="tabla-productos">
                    <thead class="table-light">
                      <tr>
                        <th>Nombre</th>
                        <th>ID</th>
                        <th>Categoria</th>
                        <th>Proveedor</th>
                        <th>Stock Actual</th>
                        <th>Fecha Vencimiento</th>
                        <th>Precio Venta</th>
                        <th class="text-end">Acciones</th>
                      </tr>
                    </thead>
                    <tbody>

                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>
        </div>
      </main>
    </div>
  </div>

  <!-- Modal: Añadir Producto -->
  <div class="modal fade" id="modalNuevo" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Añadir Producto</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="productForm" onsubmit="return false;">
            <div class="row g-2">
              <div class="col-md-6">
                <label class="form-label">Nombre</label>
                <input id="p_name" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">ID</label>
                <input id="p_sku" class="form-control" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">Categoria</label>
                <select id="p_category" class="form-select"></select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Stock</label>
                <input id="p_stock" type="number" class="form-control" min="0">
              </div>
              <div class="col-md-4">
                <label class="form-label">Fecha Vencimiento</label>
                <input id="p_exp" type="date" class="form-control" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">Proveedor</label>
                <select id="p_supplier" class="form-select" required></select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Precio Venta</label>
                <input id="p_pv" type="number" class="form-control" min="0"></input>
              </div>
              <div class="col-md-4">
                <label class="form-label">Precio Compra</label>
                <input id="p_pc" type="number" class="form-control" min="0"></input>
              </div>
              <div class="col-md-12">
                <label class="form-label">Descripción</label>
                <input id="p_desc" class="form-control"></input>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-success" id="btnGuardar">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Editar Producto -->
  <div class="modal fade" id="modalEditar" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Editar Producto</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editForm" onsubmit="return false;">
            <input type="hidden" id="edit_id_original">
            <div class="row g-2">
              <div class="col-md-6">
                <label class="form-label">Nombre</label>
                <input id="edit_name" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">ID</label>
                <input id="edit_sku" class="form-control" required readonly>
              </div>
              <div class="col-md-4">
                <label class="form-label">Categoria</label>
                <select id="edit_category" class="form-select"></select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Stock</label>
                <input id="edit_stock" type="number" class="form-control" min="0">
              </div>
              <div class="col-md-4">
                <label class="form-label">Fecha Vencimiento</label>
                <input id="edit_exp" type="date" class="form-control" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">Proveedor</label>
                <select id="edit_supplier" class="form-select" required></select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Precio Venta</label>
                <input id="edit_pv" type="number" class="form-control" min="0">
              </div>
              <div class="col-md-4">
                <label class="form-label">Precio Compra</label>
                <input id="edit_pc" type="number" class="form-control" min="0">
              </div>
              <div class="col-md-12">
                <label class="form-label">Descripción</label>
                <input id="edit_desc" class="form-control">
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-warning" id="btnActualizar">Actualizar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Script para cargar datos -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // helpers
      const $ = id => document.getElementById(id);
      const safeLog = (...args) => console.log('[Inventario]', ...args);

      // elementos
      const tbody = document.querySelector('#tabla-productos tbody');
      const inputBusqueda = $('busquedaNombre');
      const btnGuardar = $('btnGuardar');
      const selectCategorias = $('p_category');
      const selectProveedores = $('p_supplier');
      const filtroCategoria = $('filtroCategoria');
      const filtroProveedor = $('filtroProveedor');
      
      // Elementos del modal de edición
      const editCategorias = $('edit_category');
      const editProveedores = $('edit_supplier');
      const btnActualizar = $('btnActualizar');

      let productos = [];

      // fetch seguro que revisa status y JSON
      async function fetchJson(url) {
        try {
          const res = await fetch(url);
          if (!res.ok) {
            const text = await res.text().catch(() => '');
            console.error(`Error al pedir ${url}: ${res.status}`, text);
            throw new Error(`HTTP ${res.status} - ${url}`);
          }

          // intentar parsear JSON; si falla mostramos el texto (posible HTML de error)
          const contentType = res.headers.get('content-type') || '';
          if (!contentType.includes('application/json')) {
            const txt = await res.text();
            console.error(`Respuesta no JSON en ${url}:`, txt.slice(0, 200));
            throw new Error('Respuesta no JSON');
          }

          return await res.json();
        } catch (err) {
          console.error('fetchJson fallo para', url, err);
          throw err;
        }
      }

      // Cargar categorías (con manejo de errores)
      async function cargarCategorias() {
        try {
          const data = await fetchJson('http://localhost:8000/api/categorias/');
          // si select no existe, avisar y salir
          if (!selectCategorias) {
            console.warn('selectCategorias no encontrado en el DOM');
            return;
          }
          selectCategorias.innerHTML = '<option value="">Seleccione categoría</option>';
          if (Array.isArray(data) && data.length) {
            data.forEach(c => {
              const id = c.id_categoria ?? c.id ?? c.id_categoria;
              const nombre = c.nombre_categoria ?? c.nombre ?? c.nombre_categoria;
              selectCategorias.insertAdjacentHTML('beforeend', `<option value="${id}">${nombre}</option>`);
            });
          } else {
            selectCategorias.insertAdjacentHTML('beforeend', `<option value="">No hay categorías</option>`);
          }
          // actualizar filtro si existe
          if (filtroCategoria) filtroCategoria.innerHTML = selectCategorias.innerHTML;
          // actualizar select de edición
          if (editCategorias) editCategorias.innerHTML = selectCategorias.innerHTML;
        } catch (err) {
          if (selectCategorias) selectCategorias.innerHTML = '<option value="">Error al cargar</option>';
        }
      }

      // Cargar proveedores
      async function cargarProveedores() {
        try {
          const data = await fetchJson('http://localhost:8000/api/proveedores/');
          if (!selectProveedores) {
            console.warn('selectProveedores no encontrado en el DOM');
            return;
          }
          selectProveedores.innerHTML = '<option value="">Seleccione proveedor</option>';
          if (Array.isArray(data) && data.length) {
            data.forEach(p => {
              const id = p.id_proveedor ?? p.id ?? p.id_proveedor;
              const nombre = p.nombre_proveedor ?? p.nombre ?? p.nombre_proveedor;
              selectProveedores.insertAdjacentHTML('beforeend', `<option value="${id}">${nombre}</option>`);
            });
          } else {
            selectProveedores.insertAdjacentHTML('beforeend', `<option value="">No hay proveedores</option>`);
          }
          if (filtroProveedor) filtroProveedor.innerHTML = selectProveedores.innerHTML;
          // actualizar select de edición
          if (editProveedores) editProveedores.innerHTML = selectProveedores.innerHTML;
        } catch (err) {
          if (selectProveedores) selectProveedores.innerHTML = '<option value="">Error al cargar</option>';
        }
      }

      // Cargar productos
      async function cargarProductos() {
        try {
          const data = await fetchJson('http://localhost:8000/api/productos/');
          if (!Array.isArray(data)) {
            console.error('Respuesta de /productos no es array:', data);
            productos = [];
          } else {
            productos = data;
          }
          renderTabla(productos);
        } catch (err) {
          tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">No se pudo cargar productos</td></tr>`;
        }
      }

      // Render tabla
      function renderTabla(lista) {
        if (!tbody) {
          console.warn('tbody de la tabla no encontrado');
          return;
        }
        tbody.innerHTML = '';
        if (!Array.isArray(lista) || lista.length === 0) {
          tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">Sin productos</td></tr>`;
          return;
        }
        lista.forEach(prod => {
          const nombreCat = prod.nombre_categoria ?? prod.categoria_nombre ?? '';
          const nombreProv = prod.nombre_proveedor ?? prod.proveedor_nombre ?? '';
          tbody.insertAdjacentHTML('beforeend', `
        <tr>
          <td>${prod.nombre_producto ?? ''}</td>
          <td>${prod.id_producto ?? prod.id ?? ''}</td>
          <td>${nombreCat}</td>
          <td>${nombreProv}</td>
          <td>${prod.stock_actual ?? 0}</td>
          <td>${prod.fecha_vencimiento ?? '-'}</td>
          <td>$${prod.precio_venta ?? 0}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-warning me-1" onclick="editarProducto('${prod.id_producto ?? prod.id ?? ''}')">Editar</button>
            <button class="btn btn-sm btn-danger" onclick="eliminarProducto('${prod.id_producto ?? prod.id ?? ''}')">Eliminar</button>
          </td>
        </tr>
      `);
        });
      }

      // BUSCADOR: proteger si input no existe
      if (inputBusqueda) {
        inputBusqueda.addEventListener('input', e => {
          const filtro = e.target.value.toLowerCase();
          const filtrados = productos.filter(p => (p.nombre_producto ?? '').toString().toLowerCase().includes(filtro));
          renderTabla(filtrados);
        });
      } else {
        console.warn('Input de búsqueda no encontrado (id=busquedaNombre).');
      }

      // GUARDAR: proteger si btnGuardar no existe
      if (btnGuardar) {
        btnGuardar.addEventListener('click', async () => {
          // armar objeto con validaciones básicas
          const nombre = (document.querySelector('#p_name')?.value || '').trim();
          const idProducto = (document.querySelector('#p_sku')?.value || '').trim();
          const id_categoria = parseInt(document.querySelector('#p_category')?.value) || null;
          const id_proveedor = parseInt(document.querySelector('#p_supplier')?.value) || null;
          const stock_actual = parseInt(document.querySelector('#p_stock')?.value) || 0;
          const precio_venta = parseFloat(document.querySelector('#p_pv')?.value) || 0;
          const precio_compra = parseFloat(document.querySelector('#p_pc')?.value) || null;
          const fecha_vencimiento = document.querySelector('#p_exp')?.value || null;
          const descripcion_producto = (document.querySelector('#p_desc')?.value || '').trim();

          if (!nombre || !idProducto) {
            alert('Nombre y Código/ID son obligatorios.');
            return;
          }

          const nuevo = {
            nombre_producto: nombre,
            id_producto: idProducto,
            id_categoria,
            id_proveedor,
            stock_actual,
            precio_venta,
            precio_compra,
            fecha_vencimiento,
            descripcion_producto
          };

          try {
            const res = await fetch('http://localhost:8000/api/productos/', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(nuevo)
            });
            if (!res.ok) {
              const txt = await res.text().catch(() => '');
              console.error('POST /productos falló', res.status, txt);
              alert('Error al guardar producto (ver consola).');
              return;
            }
            const body = await res.json().catch(() => ({}));
            alert('Producto agregado correctamente ✅');
            document.querySelector('#productForm')?.reset();
            try { bootstrap.Modal.getInstance(document.querySelector('#modalNuevo'))?.hide(); } catch (e) { }
            cargarProductos();
          } catch (err) {
            console.error('Error enviando nuevo producto:', err);
            alert('Error de conexión con el servidor (ver consola).');
          }
        });
      } else {
        console.warn('Botón Guardar no encontrado (id=btnGuardar).');
      }

      // EDITAR PRODUCTO
      window.editarProducto = async function(id) {
        try {
          const producto = productos.find(p => (p.id_producto ?? p.id) === id);
          if (!producto) {
            alert('Producto no encontrado');
            return;
          }
          
          // Llenar el formulario de edición
          $('edit_id_original').value = id;
          $('edit_name').value = producto.nombre_producto || '';
          $('edit_sku').value = producto.id_producto || '';
          $('edit_category').value = producto.id_categoria || '';
          $('edit_stock').value = producto.stock_actual || 0;
          $('edit_exp').value = producto.fecha_vencimiento || '';
          $('edit_supplier').value = producto.id_proveedor || '';
          $('edit_pv').value = producto.precio_venta || 0;
          $('edit_pc').value = producto.precio_compra || 0;
          $('edit_desc').value = producto.descripcion_producto || '';
          
          // Mostrar modal
          const modalEditar = new bootstrap.Modal(document.getElementById('modalEditar'));
          modalEditar.show();
        } catch (err) {
          console.error('Error al cargar producto para editar:', err);
          alert('Error al cargar datos del producto');
        }
      };

      // ACTUALIZAR PRODUCTO
      if (btnActualizar) {
        btnActualizar.addEventListener('click', async () => {
          const id = $('edit_sku')?.value || $('edit_id_original')?.value;
          const nombre = ($('edit_name')?.value || '').trim();
          const id_categoria = parseInt($('edit_category')?.value) || null;
          const id_proveedor = parseInt($('edit_supplier')?.value) || null;
          const stock_actual = parseInt($('edit_stock')?.value) || 0;
          const precio_venta = parseFloat($('edit_pv')?.value) || 0;
          const precio_compra = parseFloat($('edit_pc')?.value) || null;
          const fecha_vencimiento = $('edit_exp')?.value || null;
          const descripcion_producto = ($('edit_desc')?.value || '').trim();

          if (!nombre) {
            alert('El nombre es obligatorio.');
            return;
          }
          
          if (!id) {
            alert('ID del producto no encontrado.');
            return;
          }

          const actualizado = {
            id_producto: id,
            nombre_producto: nombre,
            id_categoria,
            id_proveedor,
            stock_actual,
            precio_venta,
            precio_compra,
            fecha_vencimiento,
            descripcion_producto
          };

          try {
            const res = await fetch(`http://localhost:8000/api/productos/${id}/`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(actualizado)
            });
            
            if (!res.ok) {
              const txt = await res.text().catch(() => '');
              console.error('PUT /productos falló', res.status, txt);
              alert('Error al actualizar producto (ver consola).');
              return;
            }
            
            alert('Producto actualizado correctamente ✅');
            try { bootstrap.Modal.getInstance(document.querySelector('#modalEditar'))?.hide(); } catch (e) { }
            cargarProductos();
          } catch (err) {
            console.error('Error actualizando producto:', err);
            alert('Error de conexión con el servidor (ver consola).');
          }
        });
      }

      // ELIMINAR PRODUCTO
      window.eliminarProducto = async function(id) {
        if (!confirm('¿Está seguro de eliminar este producto?')) {
          return;
        }

        try {
          const res = await fetch(`http://localhost:8000/api/productos/${id}/`, {
            method: 'DELETE'
          });

          if (!res.ok) {
            const txt = await res.text().catch(() => '');
            console.error('DELETE /productos falló', res.status, txt);
            alert('Error al eliminar producto (ver consola).');
            return;
          }

          alert('Producto eliminado correctamente ✅');
          cargarProductos();
        } catch (err) {
          console.error('Error eliminando producto:', err);
          alert('Error de conexión con el servidor (ver consola).');
        }
      };

      // Inicialización: cargar todo con manejo de errores
      (async () => {
        try {
          await Promise.all([cargarCategorias(), cargarProveedores(), cargarProductos()]);
          safeLog('Inicialización completa');
        } catch (err) {
          safeLog('Inicialización parcial con errores', err);
        }
      })();
    });
  </script>

  <!-- Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>